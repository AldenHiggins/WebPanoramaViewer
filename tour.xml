<krpano version="1.19" title="Kilograph Cabin">
	<include url="skin/vtourskin.xml" />

	<!-- startup action - load the first scene -->
	<action name="startup" autorun="onstart">
		<!-- showlog(true); -->
		if(startscene === null OR !scene[get(startscene)], copy(startscene,scene[0].name); );
		loadscene(get(startscene), null, MERGE);
		createGifs();
	</action>

	<action name="createGifs">
		createGifHotspot("SunsetUI", "gifs/NewSunset/SpriteSheet", 460, 260, 736, 577, 1536, 0, "true", 1, 1.126, .75, 15, "scene_sunset360");
		createGifHotspot("OfficeUI", "gifs/VisitOfficeRedesign/SpriteSheet", 100, 620, 828, 1024, 1536, 0, "true", .449, .449, .35, 15, "scene_office360");
		createGifHotspot("VRUI", "gifs/NewVR/SpriteSheet", -200, 860, 600, 600, 1536, 1, "true", 1, 1, .9, 15, "scene_watchUsWork360");
	</action>

	<!-- 
		Parameters:
		hotspotName, %1
		imageName, %2
		xPosition, %3
		yPosition, %4
		width, %5
		height, %6
		originalCubeSize, %7
		cubeSide, %8
		- Cube Sides: 
			0 Front
			1 Back
			2 Right
			3 Left
			4 Up
			5 Down
		visibility, %9
		xScale, %10
		yScale, %11
		mobileSpriteSheetScale, %12
		frameRate, %13
		sceneTheHotspotPointsTo, %14
	 -->
	<action name="createGifHotspot">
		<!-- Change the ath and atv based on what face the cube is on -->
		set(ath, 0);
		set(atv, 0);

		if (%8 == 1, set(ath, 180));
		if (%8 == 2, set(ath, 90));
		if (%8 == 3, set(ath, -90));
		if (%8 == 4, set(atv, -90));
		if (%8 == 5, set(atv, 90));

		<!-- Change the image name for a mobile device -->
		set(imageName, %2);
		if (device.mobile OR device.tablet
			,
			txtadd(imageName, get(imageName), "Mobile");
		);
		txtadd(imageName, get(imageName), ".png");

		<!-- Calculate the position and area of the hotspot based on the originalCubeSize -->
		set(xPosition, %3);
		set(yPosition, %4);
		set(width, calc(%5 * %10));
		set(height, calc(%6 * %11));
		set(originalCubeSize, %7);

		<!-- Calculate the width/height of the hotspot -->
		mul(width, 1000);
		div(width, get(originalCubeSize));

		mul(height, 1000);
		div(height, get(originalCubeSize));

		<!-- Calculate the X and Y Position of the hotspot -->
		mul(xPosition, 1000);
		div(xPosition, get(originalCubeSize));
		sub(xPosition, 500);

		mul(yPosition, 1000);
		div(yPosition, get(originalCubeSize));
		sub(yPosition, 500);

		<!-- Create the hotspot -->
		addhotspot(%1);
		set(hotspot[%1].url, get(imageName));
		set(hotspot[%1].ox, get(xPosition));
		set(hotspot[%1].oy, get(yPosition));
		set(hotspot[%1].ath, get(ath));
		set(hotspot[%1].atv, get(atv));
		set(hotspot[%1].distorted, "true");
		set(hotspot[%1].edge, "lefttop");
		set(hotspot[%1].capture, "false");
		set(hotspot[%1].visible, %9);
		set(hotspot[%1].keep, "true");
		set(hotspot[%1].scale, "1.0");
		set(hotspot[%1].width, get(width));
		set(hotspot[%1].height, get(height));

		<!-- Scale the x and y of the animation if it's on mobile -->
		if (device.mobile OR device.tablet
			,
			set(hotspot[%1].onloaded, "do_crop_animation(calc(%5 * %12), calc(%6 * %12), %13)");
			,
			set(hotspot[%1].onloaded, "do_crop_animation(%5, %6, %13)");
		);
		
		set(hotspot[%1].onclick, loadscene(%14););
	</action>

	<action name="showHideHotspots">
		set(hotspot["SunsetUI"].visible, %1);
		set(hotspot["OfficeUI"].visible, %1);
		set(hotspot["VRUI"].visible, %1);
	</action>

	<!--
		do_crop_animation(framewidth, frameheight, framerate)
		- animation by changing the image cropping
		- parameters:
		  - framewidth - the width from one frame in pixels
		  - frameheight - the height from one frame in pixels
		  - framerate - the animation frame rate in 'frames per second'
		- the image can be a vertical or horizontal (or both) image-strip / sprite-sheet
		- the action will loop automatically through all frames from left to right and top to bottom
	-->
	<action name="do_crop_animation">
		<!-- add attributes to the hotspot -->
		registerattribute(xframes, calc((imagewidth / %1) BOR 0));
		registerattribute(yframes, calc((imageheight / %2) BOR 0));
		registerattribute(frames, calc(xframes * yframes));
		registerattribute(frame, 0);

		set(crop, '0|0|%1|%2');

		setinterval(calc('crop_anim_' + name), calc(1.0 / %3),
			if(loaded
				,
				inc(frame);
				if(frame GE frames, if(onlastframe !== null, onlastframe() ); set(frame,0); );
				mod(xpos, frame, xframes);
				div(ypos, frame, xframes);
				Math.floor(ypos);
				mul(xpos, %1);
				mul(ypos, %2);
				calc(crop, xpos + '|' + ypos + '|%1|%2');
			    ,
				clearinterval(calc('crop_anim_' + name));
			);
		);
	</action>
	
	<scene name="scene_pano" title="Cabin" onstart="showHideHotspots('true')" thumburl="panos/pano.tiles/thumb.jpg" lat="" lng="" heading="">
		<view hlookat="0" vlookat="0" fovtype="MFOV" fov="120" maxpixelzoom="2.0" fovmin="70" fovmax="140" limitview="auto" />

		<preview url="panos/pano.tiles/preview.jpg" />

		<image>
			<cube url="panos/pano.tiles/pano_%s.jpg" />

			<cube url="panos/pano.tiles/mobile/pano_%s.jpg" devices="mobile" />
		</image>
	</scene>

	<scene name="scene_office360" title="Office 360 Video" onstart="showHideHotspots('false')">
		<!-- set the default view -->
		<view hlookat="0" vlookat="0" fovtype="DFOV" fov="130" fovmin="75" fovmax="150" distortion="0.0" />
		<!-- include the videoplayer plugin -->
		<plugin 
			name="video"
			url.html5="%SWFPATH%/plugins/videoplayer.js"
			url.flash="%SWFPATH%/plugins/videoplayer.swf"
			pausedonstart="true"
			loop="true"
			volume="1.0"
			videourl="video/Office360.mp4"
			onloaded="playvideo();"
        />

		<!-- use the videoplayer plugin as panoramic image source -->
		<image>
			<sphere url="plugin:video" />
		</image>
	</scene>

	<scene name="scene_watchUsWork360" title="Watch us work 360 video" onstart="showHideHotspots('false')">
		<!-- set the default view -->
		<view hlookat="0" vlookat="0" fovtype="DFOV" fov="130" fovmin="75" fovmax="150" distortion="0.0" />
		<!-- include the videoplayer plugin -->
		<plugin 
			name="video"
			url.html5="%SWFPATH%/plugins/videoplayer.js"
			url.flash="%SWFPATH%/plugins/videoplayer.swf"
			pausedonstart="true"
			loop="true"
			volume="1.0"
			videourl="video/ProjectorDemonstration.mp4"
			onloaded="playvideo();"
        />

		<!-- use the videoplayer plugin as panoramic image source -->
		<image>
			<sphere url="plugin:video" />
		</image>
	</scene>

	<scene name="scene_sunset360" title="Santa Monica Pier 360 video" onstart="showHideHotspots('false')">
		<!-- set the default view -->
		<view hlookat="0" vlookat="0" fovtype="DFOV" fov="130" fovmin="75" fovmax="150" distortion="0.0" />
		<!-- include the videoplayer plugin -->
		<plugin 
			name="video"
			url.html5="%SWFPATH%/plugins/videoplayer.js"
			url.flash="%SWFPATH%/plugins/videoplayer.swf"
			pausedonstart="true"
			loop="true"
			volume="1.0"
			videourl="video/SantaMonica.mp4"
			onloaded="playvideo();"
        />

		<!-- use the videoplayer plugin as panoramic image source -->
		<image>
			<sphere url="plugin:video" />
		</image>
	</scene>
</krpano>
